# Lake rule tests

## How to add a new test suite

To add a new test suite for the rule file `rule.coffee` one needs to add a file with the same basename
as the rule file prefixed with '-test', i.e. `test/rule-test.coffee`. Additionally the basename of the rule
file has to be appended to the `TESTS` variable in the Makefile.

## How to write tests

* Require the rule file: `rules = require '../ruleFile'`.
* Tests are run with mocha. So you can define test suites and test cases as usual with `describe` and `it`.
* Create lake and manifest JSON objects for your test case. (first two parameters for `addRule`)
* Write down expected targets and rule checkers (see [`RuleChecker`](#ruleChecker)) for them.
* Write down unexpected targets which must not be created in the test case.
* Call the [`checkRule`](#checkRule) method of the [`rule-test-helper`](#ruleTestHelper).

<a name="ruleTestHelper" />
## rule-test-helper

`rule-test-helper` provides some general methods for testing lake rules.

<a name="checkRule" />
### checkRule(rule, lake, manifest, options)

`checkRule` is a general method to execute the lake rule with a custom manifest and to test the generated make rules. It
internally calls the `addRules` method of the rule file. The `featurePath` is always 'lib/feature'.

__Arguments__

* `rule` - the required lake rule
* `lake` - used to specify lake options (i.e. first parameter of `addRule`). Default values:

```
featureBuildDirectory: '$(LOCAL_COMPONENTS)'
remoteComponentPath: '$(REMOTE_COMPONENTS)'
runtimePath: 'build/runtime'
```

* `manifest` - used to specify a manifest on which the lake rule should be executed (i.e. second parameter of `addRule`).

* `options` - options for rule checking
	* `options.expeced` - hash of `<target>: <rule checker>` pairs. Each target has to be emitted by the lake rule and
	will be checked using the specified [`RuleChecker`](#ruleChecker).
	* `options.unexpected` - list of targets which must not be emitted by the lake rule

<a name="ruleChecker" />
### class RuleChecker

A rule checker checks any make rules for a given target generated by the lake rule under test. At least one of these
make rules has to pass the checker. If none of the make rules passes the checker the test case fails.

#### constructor(name)

__Arguments__

* `name` - name of this rule checker instance

#### checkRule(rule)

This method is called for each make rule which was generated by the lake rule for the target on which the rule checker
was applied to. Use this method to test if the generated rule matches the expectations of the test case.

__Arguments__

* `rule` - make rule generated by the lake rule under test

## Common rule checkers

### class RuleDependencyChecker

A [`RuleChecker`](#ruleChecker) which checks if the make rule contains the specified dependencies.

#### constructor(deps)

__Arguments__

* `deps` - a list of dependencies which the make rule should contain

### class CopyRuleChecker

A [`RuleChecker`](#ruleChecker) which checks if the make rule is a copy rule for the specified source files.

#### constructor(src)

__Arguments__

* `src` - a list of source files

### class AlwaysTrueChecker

A [`RuleChecker`](#ruleChecker) which never fails. Use this checker to just check if the rule is present in the
generated make rules.
